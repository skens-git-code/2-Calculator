<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mathens</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="style.css">
    
</head>

<body class="dark-theme">
    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="gradient-bg"></div>
        <div class="gradients-container">
            <div class="gradient gradient-1"></div>
            <div class="gradient gradient-2"></div>
            <div class="gradient gradient-3"></div>
        </div>
        <div class="particles" id="particles"></div>
        <div class="falling-stars" id="fallingStars"></div>
        <div class="grid-overlay"></div>
    </div>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-container">
            <div class="loading-logo">
                <div class="logo-icon">ðŸ§®</div>
                <h1>Mathens.io</h1>
            </div>
            
            <div class="loading-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="loading-percentage" id="loading-percentage">0%</div>
            </div>
            
            <div class="loading-animation">
                <div class="loading-dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>
            
            <div class="loading-hint" id="loading-hint">
                Initializing calculator engine...
            </div>
        </div>
    </div>

    <!-- Main Calculator -->
    <div class="calculator-wrapper">
        <!-- Header Section -->
        <header class="header glass-card ios-26-glass">
            <div class="logo">
                <span class="logo-icon">ðŸ§®</span>
                <span>Mathens.io</span>
            </div>
            <div class="header-controls">
                <button class="theme-toggle ios-26-effect" id="theme-toggle" aria-label="Toggle theme">
                    <span id="theme-icon">ðŸŒ™</span>
                    <span id="theme-text">Dark</span>
                </button>
                <button class="sound-toggle ios-26-effect" id="sound-toggle" aria-label="Toggle sound">
                    <span>ðŸ”Š Sound</span>
                </button>
                <button class="rgb-toggle ios-26-effect" id="rgb-toggle" aria-label="Toggle RGB effects">
                    <span>ðŸŒˆ RGB</span>
                </button>
            </div>
        </header>

        <!-- Calculator Container -->
        <main class="calculator-container glass-card ios-26-glass">
            <!-- Mode Selector -->
            <div class="mode-selector">
                <button class="mode-btn active" data-mode="normal">Normal</button>
                <button class="mode-btn" data-mode="scientific">Scientific</button>
                <button class="mode-btn" data-mode="advanced">Advanced</button>
                <button class="mode-btn" data-mode="currency">Currency</button>
                <button class="mode-btn" data-mode="unit">Unit</button>
            </div>

            <!-- Display Area with History -->
            <div class="display-container glass-card ios-26-glass">
                <div class="memory-indicator" id="memory-indicator">M</div>
                <div class="calculation" id="calculation"></div>
                <div class="result" id="result">0</div>
                
                <!-- History Panel -->
                <div class="history-panel" id="history-panel">
                    <div class="history-header">
                        <div class="history-title">Calculation History</div>
                        <button class="clear-history" id="clear-history">Clear</button>
                    </div>
                    <ul class="history-list" id="history-list">
                        <!-- History items will be added here dynamically -->
                    </ul>
                </div>
            </div>

            <!-- Normal Calculator Buttons -->
            <div class="button-grid" id="normal-calculator">
                <button class="btn btn-history ios-26-effect" data-action="history" aria-label="Show history">ðŸ“œ</button>
                <button class="btn btn-memory ios-26-effect" data-action="memory-clear" aria-label="Memory clear">MC</button>
                <button class="btn btn-memory ios-26-effect" data-action="memory-recall" aria-label="Memory recall">MR</button>
                <button class="btn btn-clear ios-26-effect" data-action="clear" aria-label="Clear">C</button>
                
                <button class="btn btn-clear ios-26-effect" data-action="clear-entry" aria-label="Clear entry">CE</button>
                <button class="btn btn-operation ios-26-effect" data-action="backspace" aria-label="Backspace">âŒ«</button>
                <button class="btn btn-operation ios-26-effect" data-operation="/" aria-label="Divide">Ã·</button>
                <button class="btn btn-operation ios-26-effect" data-operation="^" aria-label="Power">x^y</button>
                
                <button class="btn ios-26-effect" data-number="7" aria-label="7">7</button>
                <button class="btn ios-26-effect" data-number="8" aria-label="8">8</button>
                <button class="btn ios-26-effect" data-number="9" aria-label="9">9</button>
                <button class="btn btn-operation ios-26-effect" data-operation="*" aria-label="Multiply">Ã—</button>
                
                <button class="btn ios-26-effect" data-number="4" aria-label="4">4</button>
                <button class="btn ios-26-effect" data-number="5" aria-label="5">5</button>
                <button class="btn ios-26-effect" data-number="6" aria-label="6">6</button>
                <button class="btn btn-operation ios-26-effect" data-operation="-" aria-label="Subtract">âˆ’</button>
                
                <button class="btn ios-26-effect" data-number="1" aria-label="1">1</button>
                <button class="btn ios-26-effect" data-number="2" aria-label="2">2</button>
                <button class="btn ios-26-effect" data-number="3" aria-label="3">3</button>
                <button class="btn btn-operation ios-26-effect" data-operation="+" aria-label="Add">+</button>
                
                <button class="btn btn-memory ios-26-effect" data-action="memory-add" aria-label="Memory add">M+</button>
                <button class="btn ios-26-effect" data-number="0" aria-label="0">0</button>
                <button class="btn ios-26-effect" data-number="." aria-label="Decimal point">.</button>
                <button class="btn btn-equals ios-26-effect" data-action="calculate" aria-label="Equals">=</button>
            </div>

            <!-- Scientific Calculator Buttons -->
            <div class="scientific-buttons" id="scientific-calculator" style="display: none;">
                <button class="btn btn-operation ios-26-effect" data-operation="sin" aria-label="Sine">sin</button>
                <button class="btn btn-operation ios-26-effect" data-operation="cos" aria-label="Cosine">cos</button>
                <button class="btn btn-operation ios-26-effect" data-operation="tan" aria-label="Tangent">tan</button>
                <button class="btn btn-operation ios-26-effect" data-operation="log" aria-label="Logarithm base 10">log</button>
                <button class="btn btn-operation ios-26-effect" data-operation="ln" aria-label="Natural logarithm">ln</button>
                
                <button class="btn btn-operation ios-26-effect" data-operation="asin" aria-label="Inverse sine">asin</button>
                <button class="btn btn-operation ios-26-effect" data-operation="acos" aria-label="Inverse cosine">acos</button>
                <button class="btn btn-operation ios-26-effect" data-operation="atan" aria-label="Inverse tangent">atan</button>
                <button class="btn btn-operation ios-26-effect" data-operation="sqrt" aria-label="Square root">âˆš</button>
                <button class="btn btn-operation ios-26-effect" data-operation="square" aria-label="Square">xÂ²</button>
                
                <button class="btn btn-operation ios-26-effect" data-operation="factorial" aria-label="Factorial">x!</button>
                <button class="btn btn-operation ios-26-effect" data-operation="pi" aria-label="Pi">Ï€</button>
                <button class="btn btn-operation ios-26-effect" data-operation="e" aria-label="Euler's number">e</button>
                <button class="btn btn-operation ios-26-effect" data-operation="mod" aria-label="Modulo">mod</button>
                <button class="btn btn-operation ios-26-effect" data-operation="exp" aria-label="Exponential">exp</button>
            </div>

            <!-- Advanced Calculator Buttons -->
            <div class="advanced-buttons" id="advanced-calculator" style="display: none;">
                <button class="btn btn-operation ios-26-effect" data-operation="percent" aria-label="Percentage">%</button>
                <button class="btn btn-operation ios-26-effect" data-operation="combination" aria-label="Combination">C(n,r)</button>
                <button class="btn btn-operation ios-26-effect" data-operation="permutation" aria-label="Permutation">P(n,r)</button>
                <button class="btn btn-operation ios-26-effect" data-operation="mean" aria-label="Mean">Mean</button>
                <button class="btn btn-operation ios-26-effect" data-operation="median" aria-label="Median">Median</button>
                
                <button class="btn btn-operation ios-26-effect" data-operation="std" aria-label="Standard deviation">Std Dev</button>
                <button class="btn btn-operation ios-26-effect" data-operation="var" aria-label="Variance">Variance</button>
                <button class="btn btn-operation ios-26-effect" data-operation="gcd" aria-label="Greatest common divisor">GCD</button>
                <button class="btn btn-operation ios-26-effect" data-operation="lcm" aria-label="Least common multiple">LCM</button>
                <button class="btn btn-operation ios-26-effect" data-operation="log2" aria-label="Logarithm base 2">logâ‚‚</button>
            </div>

            <!-- Currency Converter -->
            <div class="currency-converter" id="currency-converter">
                <div class="converter-group">
                    <label for="from-currency">From Currency</label>
                    <div class="converter-selector">
                        <select id="from-currency" class="ios-26-effect">
                            <option value="USD">USD - US Dollar</option>
                            <option value="EUR">EUR - Euro</option>
                            <option value="GBP">GBP - British Pound</option>
                            <option value="INR" selected>INR - Indian Rupee</option>
                            <option value="JPY">JPY - Japanese Yen</option>
                        </select>
                        <input type="number" id="from-amount" class="ios-26-effect" placeholder="0" value="1" min="0" step="any">
                    </div>
                </div>
                
                <div class="converter-group">
                    <label for="to-currency">To Currency</label>
                    <div class="converter-selector">
                        <select id="to-currency" class="ios-26-effect">
                            <option value="USD">USD - US Dollar</option>
                            <option value="EUR">EUR - Euro</option>
                            <option value="GBP">GBP - British Pound</option>
                            <option value="INR">INR - Indian Rupee</option>
                            <option value="JPY" selected>JPY - Japanese Yen</option>
                        </select>
                        <input type="number" id="to-amount" class="ios-26-effect" placeholder="0" readonly>
                    </div>
                </div>
                
                <button class="btn btn-equals ios-26-effect" id="convert-currency">Convert</button>
            </div>

            <!-- Unit Converter -->
            <div class="unit-converter" id="unit-converter">
                <div class="converter-group">
                    <label for="unit-category">Category</label>
                    <select id="unit-category" class="ios-26-effect">
                        <option value="length">Length</option>
                        <option value="weight">Weight</option>
                        <option value="temperature">Temperature</option>
                        <option value="area">Area</option>
                        <option value="volume">Volume</option>
                    </select>
                </div>
                
                <div class="converter-group">
                    <label for="from-unit">From Unit</label>
                    <div class="converter-selector">
                        <select id="from-unit" class="ios-26-effect">
                            <!-- Options will be populated dynamically -->
                        </select>
                        <input type="number" id="from-unit-value" class="ios-26-effect" placeholder="0" value="1" step="any">
                    </div>
                </div>
                
                <div class="converter-group">
                    <label for="to-unit">To Unit</label>
                    <div class="converter-selector">
                        <select id="to-unit" class="ios-26-effect">
                            <!-- Options will be populated dynamically -->
                        </select>
                        <input type="number" id="to-unit-value" class="ios-26-effect" placeholder="0" readonly>
                    </div>
                </div>
                
                <button class="btn btn-equals ios-26-effect" id="convert-unit">Convert</button>
            </div>
        </main>

        <!-- Footer Section -->
        <footer class="footer glass-card ios-26-glass">
            <p>All CopyRights Are Reserved By Sarthak Mathapati </p>
        </footer>
    </div>

    <!-- Keyboard Shortcut Hint -->
    <div class="keyboard-hint" id="keyboard-hint" role="status" aria-live="polite"></div>

    <script>
        // Enhanced Calculator Application
        class CalculatorApp {
            constructor() {
                this.state = {
                    currentInput: '0',
                    previousInput: '',
                    operation: null,
                    resetInput: false,
                    memory: 0,
                    isRadians: false,
                    calculationHistory: [],
                    currentMode: 'normal',
                    soundEnabled: true,
                    hasMemory: false,
                    rgbEffects: true
                };
                
                this.elements = {
                    calculation: document.getElementById('calculation'),
                    result: document.getElementById('result'),
                    themeToggle: document.getElementById('theme-toggle'),
                    themeIcon: document.getElementById('theme-icon'),
                    themeText: document.getElementById('theme-text'),
                    soundToggle: document.getElementById('sound-toggle'),
                    rgbToggle: document.getElementById('rgb-toggle'),
                    modeButtons: document.querySelectorAll('.mode-btn'),
                    normalCalculator: document.getElementById('normal-calculator'),
                    scientificCalculator: document.getElementById('scientific-calculator'),
                    advancedCalculator: document.getElementById('advanced-calculator'),
                    currencyConverter: document.getElementById('currency-converter'),
                    unitConverter: document.getElementById('unit-converter'),
                    fromCurrency: document.getElementById('from-currency'),
                    toCurrency: document.getElementById('to-currency'),
                    fromAmount: document.getElementById('from-amount'),
                    toAmount: document.getElementById('to-amount'),
                    convertButton: document.getElementById('convert-currency'),
                    unitCategory: document.getElementById('unit-category'),
                    fromUnit: document.getElementById('from-unit'),
                    toUnit: document.getElementById('to-unit'),
                    fromUnitValue: document.getElementById('from-unit-value'),
                    toUnitValue: document.getElementById('to-unit-value'),
                    convertUnitButton: document.getElementById('convert-unit'),
                    historyPanel: document.getElementById('history-panel'),
                    historyList: document.getElementById('history-list'),
                    clearHistoryButton: document.getElementById('clear-history'),
                    keyboardHint: document.getElementById('keyboard-hint'),
                    memoryIndicator: document.getElementById('memory-indicator'),
                    loadingScreen: document.getElementById('loading-screen'),
                    progressFill: document.getElementById('progress-fill'),
                    loadingPercentage: document.getElementById('loading-percentage'),
                    loadingHint: document.getElementById('loading-hint')
                };
                
                this.config = {
                    maxInputLength: 15,
                    scientificNotationThreshold: 1e10,
                    scientificNotationSmallThreshold: 1e-6
                };
                
                this.exchangeRates = {
                    USD: 1,
                    EUR: 0.92,
                    GBP: 0.79,
                    INR: 83.25,
                    JPY: 148.50
                };
                
                this.unitConversions = {
                    length: {
                        meters: 1,
                        kilometers: 0.001,
                        centimeters: 100,
                        millimeters: 1000,
                        miles: 0.000621371,
                        feet: 3.28084,
                        inches: 39.3701,
                        yards: 1.09361
                    },
                    weight: {
                        kilograms: 1,
                        grams: 1000,
                        pounds: 2.20462,
                        ounces: 35.274,
                        tons: 0.00110231
                    },
                    temperature: {
                        celsius: { convert: (val) => val, reverse: (val) => val },
                        fahrenheit: { convert: (val) => (val * 9/5) + 32, reverse: (val) => (val - 32) * 5/9 },
                        kelvin: { convert: (val) => val + 273.15, reverse: (val) => val - 273.15 }
                    },
                    area: {
                        'square meters': 1,
                        'square kilometers': 0.000001,
                        'square miles': 0.000000386102,
                        acres: 0.000247105,
                        hectares: 0.0001,
                        'square feet': 10.7639
                    },
                    volume: {
                        liters: 1,
                        milliliters: 1000,
                        'cubic meters': 0.001,
                        gallons: 0.264172,
                        'cubic feet': 0.0353147
                    }
                };
                
                this.keyboardShortcuts = {
                    '0': '0', '1': '1', '2': '2', '3': '3', '4': '4',
                    '5': '5', '6': '6', '7': '7', '8': '8', '9': '9',
                    '.': '.', '+': '+', '-': '-', '*': '*', '/': '/',
                    'Enter': 'calculate', '=': 'calculate',
                    'Escape': 'clear', 'Delete': 'clear-entry',
                    'Backspace': 'backspace', '%': 'percent'
                };
                
                this.audioContext = null;
                this.rgbInterval = null;
                this.keyboardHintTimeout = null;
                this.isMobile = window.innerWidth <= 768;
                this.prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            }
            
            // Initialize the application
            init() {
                this.setupLoadingScreen();
                this.setupEventListeners();
                this.loadSavedData();
                this.performInitialConversions();
                this.startRGBAnimation();
                this.createBackgroundEffects();
            }
            
            // Setup loading screen
            setupLoadingScreen() {
                const phases = [
                    { progress: 20, hint: "Initializing calculator engine..." },
                    { progress: 40, hint: "Loading mathematical functions..." },
                    { progress: 60, hint: "Setting up user interface..." },
                    { progress: 80, hint: "Preparing animations..." },
                    { progress: 95, hint: "Almost ready..." },
                    { progress: 100, hint: "Welcome to Mathens.io!" }
                ];
                
                phases.forEach((phase, index) => {
                    setTimeout(() => {
                        this.updateProgress(phase.progress);
                        this.updateHint(phase.hint);
                        
                        if (phase.progress === 100) {
                            setTimeout(() => {
                                this.elements.loadingScreen.classList.add('fade-out');
                                setTimeout(() => {
                                    this.elements.loadingScreen.style.display = 'none';
                                }, 800);
                            }, 1000);
                        }
                    }, (index + 1) * 800);
                });
            }
            
            updateProgress(percentage) {
                this.elements.progressFill.style.width = `${percentage}%`;
                this.elements.loadingPercentage.textContent = `${percentage}%`;
            }
            
            updateHint(hint) {
                this.elements.loadingHint.style.opacity = '0';
                setTimeout(() => {
                    this.elements.loadingHint.textContent = hint;
                    this.elements.loadingHint.style.opacity = '1';
                }, 200);
            }
            
            // Create background effects
            createBackgroundEffects() {
                if (this.prefersReducedMotion) return;
                
                this.createParticles();
                this.createFallingStars();
            }
            
            createParticles() {
                const particlesContainer = document.getElementById('particles');
                if (!particlesContainer) return;
                
                const particleCount = this.isMobile ? 20 : 40;
                const fragment = document.createDocumentFragment();
                
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    
                    const size = this.random(1, 3);
                    const left = this.random(0, 100);
                    const duration = this.random(6, 12);
                    const delay = this.random(0, 10);
                    
                    Object.assign(particle.style, {
                        width: `${size}px`,
                        height: `${size}px`,
                        left: `${left}vw`,
                        animationDuration: `${duration}s`,
                        animationDelay: `${delay}s`
                    });
                    
                    fragment.appendChild(particle);
                }
                
                particlesContainer.appendChild(fragment);
            }
            
            createFallingStars() {
                const starsContainer = document.getElementById('fallingStars');
                if (!starsContainer) return;
                
                const starCount = this.isMobile ? 12 : 25;
                const fragment = document.createDocumentFragment();
                
                for (let i = 0; i < starCount; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    
                    const left = this.random(0, 100);
                    const duration = this.random(1.5, 2.5);
                    const delay = this.random(0, 2);
                    const size = this.random(3, 6);
                    
                    Object.assign(star.style, {
                        left: `${left}vw`,
                        animationDuration: `${duration}s`,
                        animationDelay: `${delay}s`,
                        width: `${size}px`,
                        height: `${size}px`
                    });
                    
                    const accentColors = [
                        'var(--accent-1)', 'var(--accent-2)', 'var(--accent-3)', 
                        'var(--accent-4)', 'var(--accent-5)', 'var(--accent-6)',
                        'var(--accent-7)', 'var(--accent-8)', 'var(--accent-9)'
                    ];
                    star.style.background = accentColors[Math.floor(Math.random() * accentColors.length)];
                    
                    fragment.appendChild(star);
                }
                
                starsContainer.appendChild(fragment);
            }
            
            random(min, max) {
                return Math.random() * (max - min) + min;
            }
            
            // Setup event listeners
            setupEventListeners() {
                // Event delegation for calculator buttons
                document.addEventListener('click', (e) => {
                    const button = e.target.closest('.btn');
                    if (!button) return;
                    
                    this.playSound('click');
                    
                    const action = button.getAttribute('data-action');
                    const number = button.getAttribute('data-number');
                    const operation = button.getAttribute('data-operation');
                    
                    if (number !== null) {
                        this.inputNumber(number);
                    } else if (operation !== null) {
                        this.handleOperation(operation);
                    } else if (action !== null) {
                        this.handleAction(action);
                    }
                });
                
                // Mode switching
                this.elements.modeButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        this.playSound('click');
                        const mode = button.getAttribute('data-mode');
                        this.switchMode(mode);
                        
                        this.elements.modeButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                    });
                });
                
                // Theme and sound toggles
                this.elements.themeToggle.addEventListener('click', () => this.toggleTheme());
                this.elements.soundToggle.addEventListener('click', () => this.toggleSound());
                this.elements.rgbToggle.addEventListener('click', () => this.toggleRGB());
                
                // Currency converter events
                [this.elements.convertButton, this.elements.fromAmount, this.elements.fromCurrency, this.elements.toCurrency].forEach(element => {
                    element.addEventListener('input', this.debounce(() => this.convertCurrency(), 300));
                    element.addEventListener('change', () => this.convertCurrency());
                });
                
                // Unit converter events
                this.elements.unitCategory.addEventListener('change', () => this.updateUnitOptions());
                [this.elements.convertUnitButton, this.elements.fromUnitValue, this.elements.fromUnit, this.elements.toUnit].forEach(element => {
                    element.addEventListener('input', this.debounce(() => this.convertUnit(), 300));
                    element.addEventListener('change', () => this.convertUnit());
                });
                
                // History management
                this.elements.clearHistoryButton.addEventListener('click', () => this.clearHistory());
                
                // Close history panel when clicking outside
                document.addEventListener('click', (e) => {
                    if (this.elements.historyPanel.classList.contains('active') && 
                        !e.target.closest('.history-panel') && !e.target.closest('.btn-history')) {
                        this.elements.historyPanel.classList.remove('active');
                    }
                });
                
                // Keyboard support
                document.addEventListener('keydown', (e) => this.handleKeyboardInput(e));
                
                // Window resize handler
                window.addEventListener('resize', this.throttle(() => {
                    this.isMobile = window.innerWidth <= 768;
                }, 250));
            }
            
            // Input number with validation
            inputNumber(num) {
                if (this.elements.result.classList.contains('error')) {
                    this.resetCalculator();
                }
                
                if (this.state.currentInput === '0' || this.state.resetInput) {
                    this.state.currentInput = num === '.' ? '0.' : num;
                    this.state.resetInput = false;
                } else {
                    const currentLength = this.state.currentInput.replace('.', '').length;
                    if (currentLength >= this.config.maxInputLength) {
                        this.showKeyboardHint('Max digits reached');
                        return;
                    }
                    
                    if (num === '.' && this.state.currentInput.includes('.')) {
                        this.showKeyboardHint('Decimal already exists');
                        return;
                    }
                    
                    if (num === '0' && this.state.currentInput === '0') {
                        return;
                    }
                    
                    if (this.state.currentInput === '0' && num !== '.') {
                        this.state.currentInput = num;
                    } else {
                        this.state.currentInput += num;
                    }
                }
                this.updateDisplay();
            }
            
            // Handle operations
            handleOperation(op) {
                this.playSound('operation');
                
                const scientificOps = ['sin', 'cos', 'tan', 'asin', 'acos', 'atan', 'log', 'ln', 'sqrt', 'square', 'factorial', 'pi', 'e', 'mod', 'exp'];
                
                if (scientificOps.includes(op)) {
                    this.handleScientificOperation(op);
                } else {
                    if (this.state.operation !== null && !this.state.resetInput) {
                        this.calculateResult();
                    }
                    
                    this.state.previousInput = this.state.currentInput;
                    this.state.operation = op;
                    this.state.resetInput = true;
                    
                    this.elements.calculation.textContent = `${this.state.previousInput} ${this.getOperationSymbol(op)}`;
                    this.elements.result.textContent = '0';
                }
            }
            
            // Handle scientific operations
            handleScientificOperation(op) {
                let result;
                const inputValue = parseFloat(this.state.currentInput);
                
                if (isNaN(inputValue) && !['pi', 'e'].includes(op)) {
                    this.showError('Invalid input');
                    return;
                }
                
                try {
                    switch (op) {
                        case 'sin':
                            result = this.state.isRadians ? Math.sin(inputValue) : Math.sin(inputValue * Math.PI / 180);
                            break;
                        case 'cos':
                            result = this.state.isRadians ? Math.cos(inputValue) : Math.cos(inputValue * Math.PI / 180);
                            break;
                        case 'tan':
                            result = this.state.isRadians ? Math.tan(inputValue) : Math.tan(inputValue * Math.PI / 180);
                            break;
                        case 'asin':
                            result = this.state.isRadians ? Math.asin(inputValue) : Math.asin(inputValue) * 180 / Math.PI;
                            break;
                        case 'acos':
                            result = this.state.isRadians ? Math.acos(inputValue) : Math.acos(inputValue) * 180 / Math.PI;
                            break;
                        case 'atan':
                            result = this.state.isRadians ? Math.atan(inputValue) : Math.atan(inputValue) * 180 / Math.PI;
                            break;
                        case 'log':
                            result = Math.log10(inputValue);
                            break;
                        case 'ln':
                            result = Math.log(inputValue);
                            break;
                        case 'sqrt':
                            result = Math.sqrt(inputValue);
                            break;
                        case 'square':
                            result = Math.pow(inputValue, 2);
                            break;
                        case 'factorial':
                            result = this.factorial(inputValue);
                            break;
                        case 'pi':
                            result = Math.PI;
                            break;
                        case 'e':
                            result = Math.E;
                            break;
                        case 'mod':
                            result = inputValue % 1;
                            break;
                        case 'exp':
                            result = Math.exp(inputValue);
                            break;
                        default:
                            return;
                    }
                    
                    if (result !== undefined && !isNaN(result) && isFinite(result)) {
                        this.addToHistory(`${this.getOperationName(op)}(${inputValue})`, result);
                        this.state.currentInput = result.toString();
                        this.state.resetInput = true;
                        this.updateDisplay();
                    } else {
                        this.showError('Math error');
                    }
                } catch (error) {
                    this.showError('Calculation error');
                }
            }
            
            // Handle actions
            handleAction(action) {
                switch (action) {
                    case 'clear':
                        this.resetCalculator();
                        this.updateDisplay();
                        break;
                    case 'clear-entry':
                        this.resetCurrent();
                        this.updateDisplay();
                        break;
                    case 'backspace':
                        this.backspace();
                        break;
                    case 'calculate':
                        this.playSound('equals');
                        this.calculateResult();
                        break;
                    case 'history':
                        this.toggleHistory();
                        break;
                    case 'memory-clear':
                        this.memoryClear();
                        break;
                    case 'memory-recall':
                        this.memoryRecall();
                        break;
                    case 'memory-add':
                        this.memoryAdd();
                        break;
                }
            }
            
            // Calculate result
            calculateResult() {
                if (this.state.operation === null || this.state.resetInput) return;
                
                let result;
                const prev = parseFloat(this.state.previousInput);
                const current = parseFloat(this.state.currentInput);
                
                if (isNaN(prev) || isNaN(current)) {
                    this.showError('Invalid input');
                    return;
                }
                
                try {
                    switch (this.state.operation) {
                        case '+':
                            result = prev + current;
                            break;
                        case '-':
                            result = prev - current;
                            break;
                        case '*':
                            result = prev * current;
                            break;
                        case '/':
                            if (current === 0) {
                                this.showError('Division by zero');
                                return;
                            }
                            result = prev / current;
                            break;
                        case '^':
                            result = Math.pow(prev, current);
                            break;
                        case 'mod':
                            if (current === 0) {
                                this.showError('Division by zero');
                                return;
                            }
                            result = prev % current;
                            break;
                        default:
                            return;
                    }
                    
                    if (!isNaN(result) && isFinite(result)) {
                        this.addToHistory(`${prev} ${this.getOperationSymbol(this.state.operation)} ${current}`, result);
                        this.state.currentInput = result.toString();
                        this.state.operation = null;
                        this.state.previousInput = '';
                        this.state.resetInput = true;
                        this.updateDisplay();
                    } else {
                        this.showError('Calculation error');
                    }
                } catch (error) {
                    this.showError('Math error');
                }
            }
            
            // Backspace function
            backspace() {
                if (this.state.currentInput.length > 1) {
                    this.state.currentInput = this.state.currentInput.slice(0, -1);
                } else {
                    this.state.currentInput = '0';
                }
                this.updateDisplay();
            }
            
            // Update display
            updateDisplay() {
                this.elements.result.textContent = this.formatNumber(this.state.currentInput);
                this.elements.result.classList.remove('error', 'success');
                
                if (this.state.operation !== null) {
                    this.elements.calculation.textContent = `${this.formatNumber(this.state.previousInput)} ${this.getOperationSymbol(this.state.operation)}`;
                } else {
                    this.elements.calculation.textContent = '';
                }
                
                if (this.state.hasMemory) {
                    this.elements.memoryIndicator.classList.add('active');
                } else {
                    this.elements.memoryIndicator.classList.remove('active');
                }
            }
            
            // Format number for display
            formatNumber(num) {
                if (num === 'Error' || num === 'Infinity' || num === '-Infinity' || num === 'NaN') {
                    return num;
                }
                
                const number = parseFloat(num);
                if (isNaN(number)) return 'Error';
                if (!isFinite(number)) return number > 0 ? 'Infinity' : '-Infinity';
                
                if (Math.abs(number) > this.config.scientificNotationThreshold || 
                    (Math.abs(number) < this.config.scientificNotationSmallThreshold && number !== 0)) {
                    return number.toExponential(6).replace('e+', 'e').replace('e-', 'eâ»');
                }
                
                let formatted;
                if (Number.isInteger(number)) {
                    formatted = number.toString();
                } else {
                    formatted = parseFloat(number.toPrecision(12)).toString();
                    
                    if (formatted.includes('.') && formatted.split('.')[1].length > 8) {
                        formatted = number.toFixed(8).replace(/\.?0+$/, '');
                    }
                }
                
                return formatted;
            }
            
            // Switch between calculator modes
            switchMode(mode) {
                this.state.currentMode = mode;
                
                const panels = [
                    this.elements.normalCalculator, 
                    this.elements.scientificCalculator, 
                    this.elements.advancedCalculator,
                    this.elements.currencyConverter, 
                    this.elements.unitConverter
                ];
                
                panels.forEach(el => el.style.display = 'none');
                
                switch (mode) {
                    case 'normal':
                        this.elements.normalCalculator.style.display = 'grid';
                        break;
                    case 'scientific':
                        this.elements.normalCalculator.style.display = 'grid';
                        this.elements.scientificCalculator.style.display = 'grid';
                        break;
                    case 'advanced':
                        this.elements.normalCalculator.style.display = 'grid';
                        this.elements.advancedCalculator.style.display = 'grid';
                        break;
                    case 'currency':
                        this.elements.currencyConverter.style.display = 'flex';
                        break;
                    case 'unit':
                        this.elements.unitConverter.style.display = 'flex';
                        break;
                }
            }
            
            // Toggle theme
            toggleTheme() {
                document.body.classList.toggle('light-mode');
                document.body.classList.toggle('dark-theme');
                
                if (document.body.classList.contains('light-mode')) {
                    this.elements.themeIcon.textContent = 'â˜€ï¸';
                    this.elements.themeText.textContent = 'Light';
                } else {
                    this.elements.themeIcon.textContent = 'ðŸŒ™';
                    this.elements.themeText.textContent = 'Dark';
                }
                
                // Restart RGB animation with new theme
                if (this.state.rgbEffects) {
                    this.stopRGBAnimation();
                    this.startRGBAnimation();
                }
                
                localStorage.setItem('calculatorTheme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
            }
            
            // Toggle sound
            toggleSound() {
                this.state.soundEnabled = !this.state.soundEnabled;
                this.elements.soundToggle.classList.toggle('muted', !this.state.soundEnabled);
                this.showKeyboardHint(this.state.soundEnabled ? 'Sound On' : 'Sound Off');
                localStorage.setItem('calculatorSound', this.state.soundEnabled.toString());
            }
            
            // Toggle RGB effects
            toggleRGB() {
                this.state.rgbEffects = !this.state.rgbEffects;
                this.elements.rgbToggle.classList.toggle('disabled', !this.state.rgbEffects);
                
                if (this.state.rgbEffects) {
                    this.startRGBAnimation();
                    this.showKeyboardHint('RGB Effects On');
                } else {
                    this.stopRGBAnimation();
                    this.showKeyboardHint('RGB Effects Off');
                }
                
                localStorage.setItem('calculatorRGB', this.state.rgbEffects.toString());
            }
            
            // Start RGB background animation
            startRGBAnimation() {
                if (!this.state.rgbEffects) return;
                
                const body = document.body;
                let hue = 0;
                
                this.rgbInterval = setInterval(() => {
                    hue = (hue + 0.5) % 360;
                    
                    if (document.body.classList.contains('light-mode')) {
                        // Light mode gradient
                        body.style.background = `linear-gradient(-45deg, 
                            hsl(${hue}, 100%, 85%), 
                            hsl(${(hue + 90) % 360}, 100%, 85%), 
                            hsl(${(hue + 180) % 360}, 100%, 85%), 
                            hsl(${(hue + 270) % 360}, 100%, 85%))`;
                    } else {
                        // Dark mode gradient
                        body.style.background = `linear-gradient(-45deg, 
                            hsl(${hue}, 70%, 40%), 
                            hsl(${(hue + 90) % 360}, 70%, 40%), 
                            hsl(${(hue + 180) % 360}, 70%, 40%), 
                            hsl(${(hue + 270) % 360}, 70%, 40%))`;
                    }
                    
                    body.style.backgroundSize = '400% 400%';
                }, 50);
            }
            
            // Stop RGB animation
            stopRGBAnimation() {
                if (this.rgbInterval) {
                    clearInterval(this.rgbInterval);
                    this.rgbInterval = null;
                    
                    // Reset to static gradient
                    if (document.body.classList.contains('light-mode')) {
                        document.body.style.background = 'linear-gradient(-45deg, #ff9a9e, #fad0c4, #fad0c4, #a1c4fd)';
                    } else {
                        document.body.style.background = 'linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab)';
                    }
                    document.body.style.backgroundSize = '400% 400%';
                }
            }
            
            // Play sound effects
            playSound(type) {
                if (!this.state.soundEnabled || !window.AudioContext) return;
                
                try {
                    if (!this.audioContext) {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    let frequency = 800;
                    switch(type) {
                        case 'operation': frequency = 600; break;
                        case 'equals': frequency = 400; break;
                    }
                    
                    oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.1);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + 0.1);
                } catch (error) {
                    console.log('Audio error:', error);
                }
            }
            
            // Currency conversion
            convertCurrency() {
                const from = this.elements.fromCurrency.value;
                const to = this.elements.toCurrency.value;
                const amount = parseFloat(this.elements.fromAmount.value) || 0;
                
                if (amount < 0) {
                    this.elements.toAmount.value = '0';
                    return;
                }
                
                const amountInUSD = amount / this.exchangeRates[from];
                const convertedAmount = amountInUSD * this.exchangeRates[to];
                
                this.elements.toAmount.value = convertedAmount.toFixed(4);
            }
            
            // Unit conversion
            updateUnitOptions() {
                const category = this.elements.unitCategory.value;
                const units = Object.keys(this.unitConversions[category]);
                
                this.elements.fromUnit.innerHTML = '';
                this.elements.toUnit.innerHTML = '';
                
                units.forEach(unit => {
                    const fromOption = document.createElement('option');
                    fromOption.value = unit;
                    fromOption.textContent = unit;
                    this.elements.fromUnit.appendChild(fromOption);
                    
                    const toOption = document.createElement('option');
                    toOption.value = unit;
                    toOption.textContent = unit;
                    this.elements.toUnit.appendChild(toOption);
                });
                
                const defaults = {
                    length: { from: 'meters', to: 'feet' },
                    weight: { from: 'kilograms', to: 'pounds' },
                    temperature: { from: 'celsius', to: 'fahrenheit' },
                    area: { from: 'square meters', to: 'square feet' },
                    volume: { from: 'liters', to: 'gallons' }
                };
                
                if (defaults[category]) {
                    this.elements.fromUnit.value = defaults[category].from;
                    this.elements.toUnit.value = defaults[category].to;
                }
                
                this.convertUnit();
            }
            
            convertUnit() {
                const category = this.elements.unitCategory.value;
                const from = this.elements.fromUnit.value;
                const to = this.elements.toUnit.value;
                const value = parseFloat(this.elements.fromUnitValue.value) || 0;
                
                let result;
                
                if (category === 'temperature') {
                    const inCelsius = from === 'celsius' ? value : 
                                     from === 'fahrenheit' ? (value - 32) * 5/9 : 
                                     value - 273.15;
                    
                    result = to === 'celsius' ? inCelsius :
                            to === 'fahrenheit' ? (inCelsius * 9/5) + 32 :
                            inCelsius + 273.15;
                } else {
                    result = value * (this.unitConversions[category][to] / this.unitConversions[category][from]);
                }
                
                this.elements.toUnitValue.value = result.toFixed(6);
            }
            
            // Memory functions
            memoryClear() {
                this.state.memory = 0;
                this.state.hasMemory = false;
                this.showKeyboardHint('Memory Cleared');
                this.updateDisplay();
            }
            
            memoryRecall() {
                this.state.currentInput = this.state.memory.toString();
                this.updateDisplay();
                this.showKeyboardHint('Memory Recalled');
            }
            
            memoryAdd() {
                this.state.memory += parseFloat(this.state.currentInput) || 0;
                this.state.hasMemory = true;
                this.showKeyboardHint('Added to Memory');
                this.updateDisplay();
            }
            
            // History functions
            toggleHistory() {
                this.elements.historyPanel.classList.toggle('active');
                if (this.elements.historyPanel.classList.contains('active')) {
                    this.updateHistoryDisplay();
                }
            }
            
            updateHistoryDisplay() {
                this.elements.historyList.innerHTML = '';
                
                if (this.state.calculationHistory.length === 0) {
                    const emptyState = document.createElement('li');
                    emptyState.className = 'history-item';
                    emptyState.innerHTML = `
                        <div style="text-align: center; opacity: 0.5; padding: 20px;">
                            No calculation history yet
                        </div>
                    `;
                    this.elements.historyList.appendChild(emptyState);
                    return;
                }
                
                this.state.calculationHistory.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'history-item';
                    li.setAttribute('data-index', index);
                    li.innerHTML = `
                        <div class="history-expression">${item.expression}</div>
                        <div class="history-result">= ${this.formatNumber(item.result.toString())}</div>
                        <div style="font-size: 0.7rem; opacity: 0.5;">
                            ${item.timestamp} â€¢ ${item.mode}
                        </div>
                    `;
                    
                    li.addEventListener('click', () => {
                        this.state.currentInput = item.result.toString();
                        this.state.resetInput = true;
                        this.updateDisplay();
                        this.elements.historyPanel.classList.remove('active');
                        this.showKeyboardHint('Result loaded from history');
                    });
                    
                    this.elements.historyList.appendChild(li);
                });
            }
            
            addToHistory(expression, result) {
                const historyItem = {
                    expression,
                    result,
                    timestamp: new Date().toLocaleString(),
                    mode: this.state.currentMode
                };
                
                this.state.calculationHistory.unshift(historyItem);
                
                if (this.state.calculationHistory.length > 50) {
                    this.state.calculationHistory.pop();
                }
                
                this.updateHistoryDisplay();
                this.saveHistory();
            }
            
            clearHistory() {
                if (this.state.calculationHistory.length === 0) return;
                
                if (confirm('Are you sure you want to clear all history?')) {
                    this.state.calculationHistory = [];
                    this.updateHistoryDisplay();
                    this.saveHistory();
                    this.showKeyboardHint('History Cleared');
                }
            }
            
            // Error handling
            showError(message) {
                this.elements.result.textContent = message;
                this.elements.result.classList.add('error');
                setTimeout(() => {
                    this.elements.result.classList.remove('error');
                    this.updateDisplay();
                }, 2000);
            }
            
            showKeyboardHint(message) {
                this.elements.keyboardHint.textContent = message;
                this.elements.keyboardHint.classList.add('show');
                
                clearTimeout(this.keyboardHintTimeout);
                this.keyboardHintTimeout = setTimeout(() => {
                    this.elements.keyboardHint.classList.remove('show');
                }, 2000);
            }
            
            // Helper functions
            factorial(n) {
                if (n < 0 || !Number.isInteger(n)) return NaN;
                if (n === 0 || n === 1) return 1;
                if (n > 170) return Infinity;
                
                let result = 1;
                for (let i = 2; i <= n; i++) {
                    result *= i;
                }
                return result;
            }
            
            getOperationSymbol(op) {
                const symbols = {
                    '+': '+', '-': 'âˆ’', '*': 'Ã—', '/': 'Ã·', '^': '^', 'mod': 'mod'
                };
                return symbols[op] || op;
            }
            
            getOperationName(op) {
                const names = {
                    'sin': 'sin', 'cos': 'cos', 'tan': 'tan', 'asin': 'asin', 'acos': 'acos',
                    'atan': 'atan', 'log': 'log', 'ln': 'ln', 'sqrt': 'âˆš', 'square': 'square',
                    'factorial': 'factorial', 'pi': 'Ï€', 'e': 'e', 'mod': 'mod', 'exp': 'exp'
                };
                return names[op] || op;
            }
            
            resetCalculator() {
                this.state.currentInput = '0';
                this.state.previousInput = '';
                this.state.operation = null;
                this.state.resetInput = false;
            }
            
            resetCurrent() {
                this.state.currentInput = '0';
                this.state.resetInput = false;
            }
            
            // Data persistence
            saveHistory() {
                try {
                    localStorage.setItem('calculatorHistory', JSON.stringify(this.state.calculationHistory));
                    localStorage.setItem('calculatorMemory', this.state.memory.toString());
                    localStorage.setItem('calculatorHasMemory', this.state.hasMemory.toString());
                    localStorage.setItem('calculatorRGB', this.state.rgbEffects.toString());
                } catch (error) {
                    console.error('Failed to save data:', error);
                }
            }
            
            loadSavedData() {
                try {
                    const savedTheme = localStorage.getItem('calculatorTheme');
                    if (savedTheme === 'light') {
                        document.body.classList.add('light-mode');
                        document.body.classList.remove('dark-theme');
                        this.elements.themeIcon.textContent = 'â˜€ï¸';
                        this.elements.themeText.textContent = 'Light';
                    } else {
                        document.body.classList.add('dark-theme');
                        document.body.classList.remove('light-mode');
                    }
                    
                    const savedSound = localStorage.getItem('calculatorSound');
                    this.state.soundEnabled = savedSound !== 'false';
                    this.elements.soundToggle.classList.toggle('muted', !this.state.soundEnabled);
                    
                    const savedRGB = localStorage.getItem('calculatorRGB');
                    this.state.rgbEffects = savedRGB !== 'false';
                    this.elements.rgbToggle.classList.toggle('disabled', !this.state.rgbEffects);
                    
                    const savedHistory = localStorage.getItem('calculatorHistory');
                    if (savedHistory) {
                        this.state.calculationHistory = JSON.parse(savedHistory);
                        this.updateHistoryDisplay();
                    }
                    
                    const savedMemory = localStorage.getItem('calculatorMemory');
                    const savedHasMemory = localStorage.getItem('calculatorHasMemory');
                    if (savedMemory) {
                        this.state.memory = parseFloat(savedMemory);
                        this.state.hasMemory = savedHasMemory === 'true';
                    }
                } catch (error) {
                    console.error('Failed to load saved data:', error);
                }
            }
            
            performInitialConversions() {
                this.convertCurrency();
                this.updateUnitOptions();
            }
            
            // Keyboard input handling
            handleKeyboardInput(event) {
                if (event.target.tagName === 'INPUT' || event.target.tagName === 'SELECT') {
                    return;
                }
                
                const key = event.key;
                
                if (this.keyboardShortcuts.hasOwnProperty(key)) {
                    event.preventDefault();
                    const action = this.keyboardShortcuts[key];
                    
                    if (action === 'calculate') {
                        this.playSound('equals');
                        this.calculateResult();
                    } else if (action === 'clear') {
                        this.resetCalculator();
                        this.updateDisplay();
                    } else if (action === 'clear-entry') {
                        this.resetCurrent();
                        this.updateDisplay();
                    } else if (action === 'backspace') {
                        this.backspace();
                    } else if (action === 'percent') {
                        this.handleOperation('percent');
                    } else {
                        if (!isNaN(action) || action === '.') {
                            this.inputNumber(action);
                        } else {
                            this.handleOperation(action);
                        }
                    }
                    
                    this.showKeyboardHint(`Pressed: ${key}`);
                }
                
                if (event.ctrlKey || event.metaKey) {
                    switch(key) {
                        case 'h':
                            event.preventDefault();
                            this.toggleHistory();
                            this.showKeyboardHint('History Toggled');
                            break;
                        case 'm':
                            event.preventDefault();
                            this.memoryAdd();
                            break;
                        case 's':
                            event.preventDefault();
                            this.toggleSound();
                            break;
                        case 'r':
                            event.preventDefault();
                            this.toggleRGB();
                            break;
                    }
                }
            }
            
            // Utility functions
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            throttle(func, limit) {
                let inThrottle;
                return function() {
                    const args = arguments;
                    const context = this;
                    if (!inThrottle) {
                        func.apply(context, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                }
            }
        }
        
        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const calculatorApp = new CalculatorApp();
            calculatorApp.init();
        });
    </script>
</body>
</html>
